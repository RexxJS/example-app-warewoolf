<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WareWoolf Control Bus Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
      background: #1e1e1e;
      color: #d4d4d4;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 50px 1fr;
      height: 100vh;
      gap: 0;
    }

    .header {
      grid-column: 1 / -1;
      background: #252526;
      border-bottom: 1px solid #3e3e42;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 500;
      color: #cccccc;
    }

    .status {
      padding: 4px 12px;
      border-radius: 3px;
      font-size: 12px;
      background: #0e639c;
      color: white;
    }

    .panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #3e3e42;
      overflow: hidden;
    }

    .panel:last-child {
      border-right: none;
    }

    .panel-header {
      background: #2d2d30;
      padding: 10px 15px;
      border-bottom: 1px solid #3e3e42;
      font-size: 13px;
      font-weight: 500;
    }

    .panel-content {
      flex: 1;
      overflow: auto;
      padding: 15px;
    }

    #script-editor {
      width: 100%;
      height: 100%;
      background: #1e1e1e;
      color: #d4d4d4;
      border: none;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 10px;
      resize: none;
      outline: none;
    }

    .button-bar {
      padding: 10px 15px;
      background: #252526;
      border-top: 1px solid #3e3e42;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 6px 16px;
      background: #0e639c;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    button:hover {
      background: #1177bb;
    }

    button:active {
      background: #0d5a8f;
    }

    button:disabled {
      background: #3e3e42;
      cursor: not-allowed;
    }

    #output {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      color: #cccccc;
    }

    .output-entry {
      padding: 8px 0;
      border-bottom: 1px solid #2d2d30;
    }

    .output-entry.error {
      color: #f48771;
    }

    .output-entry.success {
      color: #4ec9b0;
    }

    .output-timestamp {
      color: #858585;
      font-size: 11px;
      margin-bottom: 4px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    .example-scripts {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .example-btn {
      padding: 4px 10px;
      background: #3e3e42;
      font-size: 12px;
    }

    .example-btn:hover {
      background: #4e4e52;
    }

    #app-frame {
      background: #ffffff;
    }

    .info-box {
      background: #2d2d30;
      border: 1px solid #3e3e42;
      border-radius: 3px;
      padding: 12px;
      margin-bottom: 15px;
    }

    .info-box h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #4ec9b0;
    }

    .info-box p {
      font-size: 12px;
      line-height: 1.6;
      color: #cccccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üê∫ WareWoolf Control Bus Demo</h1>
      <div class="status" id="status">Not Connected</div>
    </div>

    <div class="panel">
      <div class="panel-header">RexxJS Script Editor</div>
      <div class="panel-content">
        <div class="info-box">
          <h3>Control Bus Demo</h3>
          <p>Write RexxJS scripts that control WareWoolf via the ADDRESS WOOLF interface. Click example buttons below to load sample scripts, then click "Run Script" to execute.</p>
        </div>

        <div class="example-scripts">
          <button class="example-btn" onclick="loadExample('wordcount')">Word Count</button>
          <button class="example-btn" onclick="loadExample('chapters')">List Chapters</button>
          <button class="example-btn" onclick="loadExample('append')">Append Text</button>
          <button class="example-btn" onclick="loadExample('format')">Format Text</button>
          <button class="example-btn" onclick="loadExample('replace')">Find & Replace</button>
        </div>

        <textarea id="script-editor" spellcheck="false">/* WareWoolf RexxJS Example - Get Word Count */

ADDRESS WOOLF "get-word-count"
say "Word count:" rc

ADDRESS WOOLF "list-chapters"
say "Chapters:" rc</textarea>
      </div>
      <div class="button-bar">
        <button onclick="runScript()">‚ñ∂ Run Script</button>
        <button onclick="clearOutput()">Clear Output</button>
        <button onclick="clearEditor()">Clear Editor</button>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">Output & Results</div>
      <div class="panel-content">
        <div id="output"></div>
      </div>
    </div>
  </div>

  <!-- Control bus bridge script - loaded from WareWoolf -->
  <script src="src/components/controllers/woolf-controlbus.js"></script>

  <script>
    // Example scripts library
    const examples = {
      wordcount: `/* Get total word count */
ADDRESS WOOLF "get-word-count"
say "Total words:" rc`,

      chapters: `/* List all chapters */
ADDRESS WOOLF "list-chapters"
say "Chapters:"
say rc`,

      append: `/* Append text to current chapter */
ADDRESS WOOLF "append text=This is new text added via RexxJS!"
say "Text appended successfully"`,

      format: `/* Format selected text (requires selection) */
ADDRESS WOOLF "format-selection bold=true italic=true"
say "Text formatted"`,

      replace: `/* Find and replace */
ADDRESS WOOLF "replace search=old replace-with=new"
say "Replacements made:" rc`
    };

    let director = null;
    let connected = false;

    // Initialize connection to WareWoolf app
    function initConnection() {
      // For Electron, we connect to the parent window
      const targetWindow = window.parent || window.opener;

      if (!targetWindow) {
        logOutput('ERROR: Cannot find WareWoolf window', 'error');
        return;
      }

      // Create director bridge
      director = new WoolfDirectorBridge(targetWindow);
      connected = true;
      updateStatus('Connected');
      logOutput('Connected to WareWoolf control bus', 'success');
    }

    function updateStatus(text) {
      const status = document.getElementById('status');
      status.textContent = text;
      if (text === 'Connected') {
        status.style.background = '#0e639c';
      } else if (text === 'Running...') {
        status.style.background = '#f9a825';
      } else {
        status.style.background = '#3e3e42';
      }
    }

    async function runScript() {
      if (!connected) {
        initConnection();
      }

      if (!director) {
        logOutput('ERROR: Not connected to WareWoolf', 'error');
        return;
      }

      const script = document.getElementById('script-editor').value;
      if (!script.trim()) {
        logOutput('ERROR: Script is empty', 'error');
        return;
      }

      updateStatus('Running...');
      logOutput('--- Running Script ---');

      try {
        // Parse and execute ADDRESS WOOLF commands
        const lines = script.split('\n');
        for (const line of lines) {
          const trimmed = line.trim();

          // Skip comments and empty lines
          if (!trimmed || trimmed.startsWith('/*') || trimmed.startsWith('//')) {
            continue;
          }

          // Handle ADDRESS WOOLF commands
          if (trimmed.toUpperCase().startsWith('ADDRESS WOOLF')) {
            const match = trimmed.match(/ADDRESS\s+WOOLF\s+"([^"]+)"/i);
            if (match) {
              const commandStr = match[1];
              const [command, ...paramParts] = commandStr.split(/\s+/);
              const params = {};

              // Parse parameters (key=value format)
              paramParts.forEach(part => {
                const [key, value] = part.split('=');
                if (key && value) {
                  params[key] = value;
                }
              });

              logOutput(`> ${command} ${JSON.stringify(params)}`);

              const result = await director.run(command, params);
              logOutput(`‚úì ${JSON.stringify(result, null, 2)}`, 'success');
            }
          }
          // Handle SAY commands
          else if (trimmed.toUpperCase().startsWith('SAY')) {
            const message = trimmed.substring(3).trim().replace(/^["']|["']$/g, '');
            logOutput(`SAY: ${message}`);
          }
        }

        logOutput('--- Script Completed ---', 'success');
      } catch (error) {
        logOutput(`ERROR: ${error.message}`, 'error');
      }

      updateStatus('Connected');
    }

    function loadExample(name) {
      const script = examples[name];
      if (script) {
        document.getElementById('script-editor').value = script;
        logOutput(`Loaded example: ${name}`);
      }
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    function clearEditor() {
      document.getElementById('script-editor').value = '';
    }

    function logOutput(message, type = '') {
      const output = document.getElementById('output');
      const entry = document.createElement('div');
      entry.className = `output-entry ${type}`;

      const timestamp = document.createElement('div');
      timestamp.className = 'output-timestamp';
      timestamp.textContent = new Date().toLocaleTimeString();

      const content = document.createElement('div');
      content.textContent = message;

      entry.appendChild(timestamp);
      entry.appendChild(content);
      output.appendChild(entry);

      // Auto-scroll to bottom
      output.scrollTop = output.scrollHeight;
    }

    // Auto-connect when loaded inside WareWoolf
    window.addEventListener('load', () => {
      logOutput('WareWoolf Control Bus Demo initialized');
      logOutput('Click "Run Script" to execute RexxJS commands');

      // Try to auto-connect if we're in an iframe
      if (window.parent !== window) {
        initConnection();
      }
    });
  </script>
</body>
</html>
