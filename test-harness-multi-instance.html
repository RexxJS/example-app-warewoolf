<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WareWoolf Multi-Instance Test Harness</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
    }

    h1 {
      margin-bottom: 20px;
      color: #cccccc;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .panel {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
    }

    .panel h2 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #4ec9b0;
    }

    iframe {
      width: 100%;
      height: 400px;
      border: 1px solid #3e3e42;
      background: white;
      border-radius: 3px;
    }

    .log {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      padding: 10px;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Consolas', monospace;
      font-size: 12px;
    }

    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #2d2d30;
    }

    .log-entry.info {
      color: #4ec9b0;
    }

    .log-entry.error {
      color: #f48771;
    }

    .log-entry.message {
      color: #dcdcaa;
    }

    button {
      padding: 8px 16px;
      background: #0e639c;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
    }

    button:hover {
      background: #1177bb;
    }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      margin-left: 10px;
    }

    .status.active {
      background: #0e639c;
    }

    .status.ready {
      background: #4ec9b0;
      color: #000;
    }

    code {
      background: #2d2d30;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
    }

    .info-box {
      background: #2d2d30;
      border: 1px solid #3e3e42;
      padding: 15px;
      border-radius: 3px;
      margin-bottom: 20px;
    }

    .info-box p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .info-box ul {
      margin-left: 20px;
      margin-top: 10px;
    }

    .info-box li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h1>üê∫ WareWoolf Multi-Instance Test Harness</h1>

  <div class="info-box">
    <p><strong>Architecture:</strong> This harness demonstrates the RexxJS service architecture pattern with multiple WareWoolf instances controlled by separate RexxJS scripts.</p>
    <p><strong>Pattern:</strong> Based on the calculator multi-instance example from RexxJS core tests, this shows how a message broker can route commands between multiple client-service pairs.</p>
    <ul>
      <li><code>rexx-alpha</code> ‚Üí <code>warewoolf-1</code> (Instance 1)</li>
      <li><code>rexx-beta</code> ‚Üí <code>warewoolf-2</code> (Instance 2)</li>
    </ul>
    <p><strong>Protocols Supported:</strong> Standard control messages, JSON-RPC 2.0, INTERPRET_JS requests</p>
  </div>

  <div class="container">
    <!-- Rexx Client Alpha -->
    <div class="panel">
      <h2>RexxJS Client Alpha <span class="status ready" id="status-alpha">Ready</span></h2>
      <iframe id="rexx-alpha" src="about:blank"></iframe>
      <div class="log" id="log-alpha"></div>
      <button onclick="testAlpha()">Test Alpha ‚Üí WareWoolf 1</button>
      <button onclick="clearLog('alpha')">Clear Log</button>
    </div>

    <!-- WareWoolf Instance 1 -->
    <div class="panel">
      <h2>WareWoolf Instance 1 <span class="status active" id="status-woolf1">Active</span></h2>
      <iframe id="warewoolf-1" src="woolf-controlbus-demo.html"></iframe>
      <div class="log" id="log-woolf1"></div>
    </div>

    <!-- Rexx Client Beta -->
    <div class="panel">
      <h2>RexxJS Client Beta <span class="status ready" id="status-beta">Ready</span></h2>
      <iframe id="rexx-beta" src="about:blank"></iframe>
      <div class="log" id="log-beta"></div>
      <button onclick="testBeta()">Test Beta ‚Üí WareWoolf 2</button>
      <button onclick="clearLog('beta')">Clear Log</button>
    </div>

    <!-- WareWoolf Instance 2 -->
    <div class="panel">
      <h2>WareWoolf Instance 2 <span class="status active" id="status-woolf2">Active</span></h2>
      <iframe id="warewoolf-2" src="woolf-controlbus-demo.html"></iframe>
      <div class="log" id="log-woolf2"></div>
    </div>
  </div>

  <div class="panel" style="grid-column: 1 / -1;">
    <h2>Message Broker Log</h2>
    <div class="log" id="log-broker"></div>
    <button onclick="testBoth()">Test Both Instances</button>
    <button onclick="testJsonRpc()">Test JSON-RPC</button>
    <button onclick="testInterpretJs()">Test INTERPRET_JS</button>
    <button onclick="clearLog('broker')">Clear Broker Log</button>
  </div>

  <script src="src/components/controllers/woolf-controlbus.js"></script>
  <script>
    // Service topology configuration (based on calculator multi-instance pattern)
    const serviceTopology = {
      'rexx-alpha': { iframe: 'rexx-alpha', targetService: 'warewoolf-1' },
      'rexx-beta': { iframe: 'rexx-beta', targetService: 'warewoolf-2' },
      'warewoolf-1': { iframe: 'warewoolf-1', clientTarget: 'rexx-alpha' },
      'warewoolf-2': { iframe: 'warewoolf-2', clientTarget: 'rexx-beta' }
    };

    // Message broker - routes between clients and services
    window.addEventListener('message', async function(event) {
      const { data, source } = event;
      if (!data) return;

      // Identify source frame
      let sourceId = null;
      let targetId = null;

      // Check all frames to identify source
      for (const [id, config] of Object.entries(serviceTopology)) {
        const iframe = document.getElementById(config.iframe);
        if (iframe && iframe.contentWindow === source) {
          sourceId = id;
          break;
        }
      }

      if (!sourceId) return;

      // Determine target based on topology
      const sourceConfig = serviceTopology[sourceId];

      // Route requests from clients to services
      if (sourceConfig.targetService) {
        targetId = sourceConfig.targetService;
        const targetConfig = serviceTopology[targetId];
        const targetFrame = document.getElementById(targetConfig.iframe);

        logBroker(`Routing ${data.type || 'message'} from ${sourceId} ‚Üí ${targetId}`);

        if (targetFrame && targetFrame.contentWindow) {
          targetFrame.contentWindow.postMessage(data, '*');
        }
      }
      // Route responses from services to clients
      else if (sourceConfig.clientTarget) {
        targetId = sourceConfig.clientTarget;
        const targetConfig = serviceTopology[targetId];
        const targetFrame = document.getElementById(targetConfig.iframe);

        logBroker(`Response ${data.type || 'message'} from ${sourceId} ‚Üí ${targetId}`, 'info');

        if (targetFrame && targetFrame.contentWindow) {
          targetFrame.contentWindow.postMessage(data, '*');
        }
      }
    });

    // Test functions
    async function testAlpha() {
      logAlpha('Sending test command to WareWoolf 1...');

      const alphaFrame = document.getElementById('rexx-alpha');
      const director = new WoolfDirectorBridge(
        document.getElementById('warewoolf-1').contentWindow,
        '*',
        'rexx-alpha'
      );

      try {
        const result = await director.run('set-content', { text: 'Test from Alpha' });
        logAlpha('‚úì Success: ' + JSON.stringify(result), 'info');
      } catch (error) {
        logAlpha('‚úó Error: ' + error.message, 'error');
      }
    }

    async function testBeta() {
      logBeta('Sending test command to WareWoolf 2...');

      const director = new WoolfDirectorBridge(
        document.getElementById('warewoolf-2').contentWindow,
        '*',
        'rexx-beta'
      );

      try {
        const result = await director.run('set-content', { text: 'Test from Beta' });
        logBeta('‚úì Success: ' + JSON.stringify(result), 'info');
      } catch (error) {
        logBeta('‚úó Error: ' + error.message, 'error');
      }
    }

    async function testBoth() {
      logBroker('Testing both instances simultaneously...', 'message');

      const director1 = new WoolfDirectorBridge(
        document.getElementById('warewoolf-1').contentWindow,
        '*',
        'rexx-alpha'
      );

      const director2 = new WoolfDirectorBridge(
        document.getElementById('warewoolf-2').contentWindow,
        '*',
        'rexx-beta'
      );

      try {
        await Promise.all([
          director1.run('set-content', { text: 'Instance 1 active' }),
          director2.run('set-content', { text: 'Instance 2 active' })
        ]);

        logBroker('‚úì Both instances responded', 'info');
      } catch (error) {
        logBroker('‚úó Error: ' + error.message, 'error');
      }
    }

    async function testJsonRpc() {
      logBroker('Testing JSON-RPC 2.0 protocol...', 'message');

      const director = new WoolfDirectorBridge(
        document.getElementById('warewoolf-1').contentWindow,
        '*',
        'rexx-alpha'
      );

      try {
        const result = await director.rpc('get-word-count', {});
        logBroker('‚úì JSON-RPC result: ' + JSON.stringify(result), 'info');
      } catch (error) {
        logBroker('‚úó Error: ' + error.message, 'error');
      }
    }

    async function testInterpretJs() {
      logBroker('Testing INTERPRET_JS pattern...', 'message');

      const director = new WoolfDirectorBridge(
        document.getElementById('warewoolf-1').contentWindow,
        '*',
        'rexx-alpha'
      );

      try {
        const result = await director.interpretJs('2 + 2');
        logBroker('‚úì INTERPRET_JS result: ' + result, 'info');
      } catch (error) {
        logBroker('‚úó Error: ' + error.message, 'error');
      }
    }

    // Logging functions
    function log(elementId, message, type = '') {
      const logEl = document.getElementById(elementId);
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function logAlpha(msg, type) { log('log-alpha', msg, type); }
    function logBeta(msg, type) { log('log-beta', msg, type); }
    function logBroker(msg, type) { log('log-broker', msg, type); }

    function clearLog(which) {
      document.getElementById(`log-${which}`).innerHTML = '';
    }

    // Initialize
    window.addEventListener('load', () => {
      logBroker('Multi-instance test harness initialized', 'info');
      logBroker('Service topology configured with 2 client-service pairs', 'info');
    });
  </script>
</body>
</html>
